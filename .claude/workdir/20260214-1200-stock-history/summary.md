# Summary: Stock History & Forecast Tracking

**Date:** 2026-02-14
**Status:** Completed
**Version:** 0.3.14

## What Changed

| File | Change |
|------|--------|
| `internal/models/market.go` | Added EarningsRecord, AnalystRatings, UpcomingEvent, ForecastTracking, ForecastEntry types. Extended Fundamentals with EPS estimates, earnings history, analyst ratings. Extended MarketData with upcoming events + freshness. Extended StockData with earnings/ratings/events. Extended FilingsIntelligence with ForecastTracking and UpcomingOutlook. |
| `internal/models/portfolio.go` | Extended HoldingReview with EarningsHistory, AnalystRatings, UpcomingEvents |
| `internal/clients/eodhd/client.go` | Extended fundamentalsResponse to parse Earnings.History, Highlights EPS estimates, AnalystRatings. Added GetEarningsCalendar for /calendar/earnings endpoint. Added flexString type for Rating field. Fixed flexFloat64 null handling. |
| `internal/interfaces/clients.go` | Added GetEarningsCalendar to EODHDClient interface |
| `internal/common/freshness.go` | Added FreshnessUpcomingEvents (24h) |
| `internal/services/market/service.go` | Earnings extraction from fundamentals, upcoming events collection in CollectMarketData. Earnings/ratings/events surfacing in GetStockData. Updated generateFilingsIntelligence calls to pass MarketData. |
| `internal/services/market/filings.go` | Changed generateFilingsIntelligence to accept *models.MarketData. Enhanced prompt with earnings history table, analyst consensus, forecast_tracking and upcoming_outlook in JSON schema. Extended response parsing. |
| `internal/services/portfolio/service.go` | Added earnings/ratings/events to HoldingReview via Fundamentals |
| `internal/services/market/service_test.go` | Updated mock, added TestGetStockData_SurfacesEarningsData |
| `internal/services/quote/service_test.go` | Updated mock for interface change |
| `internal/services/portfolio/service_test.go` | Updated mock for interface change |
| `internal/clients/eodhd/earnings_test.go` | 4 new tests: earnings parsing, calendar endpoint, flexString |
| `internal/services/market/filings_test.go` | 6 new tests: prompt builder, response parsing with forecast tracking |
| `internal/clients/eodhd/realtime_test.go` | Added TestFlexFloat64_UnmarshalJSON (null, number, string, N/A) |
| `README.md` | Updated get_stock_data, portfolio_compliance, and Features descriptions |
| `.claude/skills/vire-stock-report/SKILL.md` | Added earnings history, analyst consensus, upcoming events, forecast tracking |
| `.claude/skills/vire-portfolio-review/SKILL.md` | Added upcoming events to caching table, earnings data in output reference |
| `.claude/skills/vire-collect/SKILL.md` | Added earnings history, analyst ratings, upcoming events to Data Collected |

## Tests
- 14 new tests added (4 earnings parsing, 6 filings prompt/response, 1 stock data surfacing, 1 flexFloat64, 2 mock updates)
- All existing tests pass (no regressions)
- go vet clean, go build clean

## Documentation Updated
- README.md — tool descriptions and features section
- .claude/skills/vire-stock-report/SKILL.md — new data sections
- .claude/skills/vire-portfolio-review/SKILL.md — caching table and output format
- .claude/skills/vire-collect/SKILL.md — data collected section

## Review Findings
- **Data duplication** (Fundamentals + MarketData): Resolved — earnings/ratings stored on Fundamentals only, accessed via marketData.Fundamentals
- **Dead code** (EarningsUpdatedAt, FreshnessEarnings): Removed
- **flexFloat64 null handling**: Fixed with null check, test added
- **FreshnessUpcomingEvents**: Changed from 6h to 24h
- **EODHD Rating field type**: Fixed with flexString custom unmarshal
- **Calendar API wrapper**: Fixed with earningsCalendarResponse struct

## Notes
- Earnings history and analyst ratings come from the existing EODHD /fundamentals endpoint — no extra API call needed
- Only the /calendar/earnings endpoint is a new API call (24h freshness)
- Forecast tracking is generated by Gemini as part of filings intelligence — compares guidance/estimates against actuals
- Feature validated live against BHP.AU showing 8 quarters of earnings data
