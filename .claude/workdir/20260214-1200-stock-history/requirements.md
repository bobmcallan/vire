# Requirements: Stock History & Forecast Tracking

**Date:** 2026-02-14
**Requested:** When requesting a stock review/analysis, collect and summarise past 2-3 years of company updates (price sensitive) and financial reports. Track how forecasts compared to actuals. Include recent updates, performance indicators, upcoming reporting events, and forward outlook based on news/announcements. This data is generic to stocks and available to any user request.

## Scope

### In Scope
1. **Earnings history collection** — Collect EPS actual vs estimate history from EODHD fundamentals endpoint (`Earnings.History` section) and forward EPS estimates from `Highlights`
2. **Analyst ratings** — Collect consensus ratings and target prices from EODHD fundamentals `AnalystRatings` section
3. **Upcoming events** — Collect upcoming earnings dates from EODHD `/calendar/earnings` endpoint
4. **Enhanced filings intelligence** — Extend the Gemini prompt to produce explicit forecast-vs-actual tracking and upcoming event outlook sections
5. **New model types** — `EarningsRecord`, `AnalystRatings`, `UpcomingEvent`, `ForecastTracking` structs
6. **Surface in responses** — Include new data in `StockData`, `HoldingReview`, and compliance outputs

### Out of Scope
- Financial statement data (income statement, balance sheet, cash flow) — future work
- Dividend calendar — separate feature
- Custom forecast models — we use analyst consensus and company guidance from filings

## Approach

### Layer 1: EODHD Data Collection
Extend `fundamentalsResponse` struct in `internal/clients/eodhd/client.go` to parse:
- `Earnings.History` → `[]EarningsRecord` (date, epsActual, epsEstimate, difference, surprisePct)
- `Highlights` EPS estimates → fields on `Fundamentals` (EPSEstimateCurrentYear, EPSEstimateNextYear, etc.)
- `AnalystRatings` → `AnalystRatings` struct (rating, targetPrice, strongBuy/buy/hold/sell/strongSell)

Add new `GetEarningsCalendar(ctx, ticker)` method for upcoming earnings dates from `/calendar/earnings`.

### Layer 2: Model & Storage
Add to `models/market.go`:
- `EarningsRecord` — single quarter/annual earnings result with actual vs estimate
- `AnalystRatings` — consensus ratings and target price
- `UpcomingEvent` — upcoming earnings/reporting date
- `ForecastTracking` — generated by Gemini, tracks guidance accuracy

Extend `MarketData` with `EarningsHistory`, `AnalystRatings`, `UpcomingEvents` fields + freshness timestamps.
Extend `Fundamentals` with EPS estimate fields.
Extend `FilingsIntelligence` with `ForecastTracking` and `UpcomingOutlook`.
Extend `StockData` and `HoldingReview` to surface new data.

### Layer 3: Market Service
Add earnings collection step in `CollectMarketData` (between fundamentals and news).
Freshness: earnings history = same as fundamentals (7 days), upcoming events = same as news (6 hours).

### Layer 4: Enhanced Intelligence
Extend `buildFilingsIntelPrompt` to include:
- Earnings history table (actual vs estimate per quarter)
- Analyst consensus summary
- Request explicit `forecast_tracking` and `upcoming_outlook` sections in the JSON output

### Layer 5: Integration
Extend `GetStockData` response assembly to include earnings/ratings/events.
Extend `portfolio_compliance` `HoldingReview` to include the new data.

## Files Expected to Change
- `internal/clients/eodhd/client.go` — Parse earnings history, analyst ratings; add calendar endpoint
- `internal/interfaces/clients.go` — Add `GetEarningsCalendar` to `EODHDClient` interface
- `internal/models/market.go` — New types: EarningsRecord, AnalystRatings, UpcomingEvent, ForecastTracking
- `internal/common/freshness.go` — Add earnings freshness constant
- `internal/services/market/service.go` — Add earnings collection step in CollectMarketData
- `internal/services/market/filings.go` — Enhanced Gemini prompt and response parsing
- `internal/services/market/stock_data.go` — Include new data in StockData assembly
- `internal/services/portfolio/review.go` — Include new data in HoldingReview
- `test/` — Unit and integration tests
- `test/common/mocks.go` — Update mock client if interface changes
