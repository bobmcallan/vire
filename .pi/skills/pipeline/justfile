# Development Pipeline Commands

# Run pipeline skill with agent-team extension
pipeline *args:
    pi -e extensions/agent-team.ts -p "{{args}}"

# Quick feature development (no extension needed)
pipeline-quick feature:
    #!/usr/bin/env bash
    echo "Starting quick pipeline for: {{feature}}"
    echo "This runs without agent-team extension (simpler, but less parallel)"
    pi -p "Use the pipeline skill to implement: {{feature}}"

# List available teams
teams:
    pi -e extensions/agent-team.ts -p "List all available agent teams and their members"

# Show pipeline status
status:
    @echo "Pipeline Work Directories:"
    @ls -lt .claude/workdir/ 2>/dev/null || echo "No work directories found"
    @echo ""
    @echo "Test Results:"
    @ls -lt tests/logs/ 2>/dev/null || echo "No test results found"

# View last pipeline summary
last-summary:
    @latest=$$(ls -td .claude/workdir/*/ 2>/dev/null | head -1); \
    if [ -n "$$latest" ]; then \
        echo "Viewing: $$latest/summary.md"; \
        cat "$$latest/summary.md"; \
    else \
        echo "No pipeline summaries found"; \
    fi

# View last requirements
last-requirements:
    @latest=$$(ls -td .claude/workdir/*/ 2>/dev/null | head -1); \
    if [ -n "$$latest" ]; then \
        echo "Viewing: $$latest/requirements.md"; \
        cat "$$latest/requirements.md"; \
    else \
        echo "No requirements found"; \
    fi

# Clean old work directories (keep last 10)
clean-workdir:
    @echo "Cleaning old work directories..."
    @ls -td .claude/workdir/*/ 2>/dev/null | tail -n +11 | xargs -r rm -rf
    @echo "Done. Kept last 10 work directories."

# Clean old test logs (keep last 20)
clean-logs:
    @echo "Cleaning old test logs..."
    @ls -t tests/logs/*.json 2>/dev/null | tail -n +21 | xargs -r rm -f
    @echo "Done. Kept last 20 test logs."

# Verify pipeline setup
verify:
    @echo "Checking pipeline setup..."
    @echo ""
    @echo "✓ Skill definition:"
    @test -f .pi/skills/pipeline/SKILL.md && echo "  ✓ .pi/skills/pipeline/SKILL.md" || echo "  ✗ Missing SKILL.md"
    @echo ""
    @echo "✓ Agent definitions:"
    @for agent in implementer reviewer devil's-advocate test-creator test-executor; do \
        if [ -f ".pi/agents/$$agent.md" ]; then \
            echo "  ✓ $$agent.md"; \
        else \
            echo "  ✗ $$agent.md (missing)"; \
        fi; \
    done
    @echo ""
    @echo "✓ Team configuration:"
    @test -f .pi/agents/teams.yaml && echo "  ✓ teams.yaml" || echo "  ✗ Missing teams.yaml"
    @echo ""
    @echo "✓ Extension:"
    @test -f .pi/extensions.tmp/agent-team.ts && echo "  ✓ agent-team.ts" || echo "  ✗ Missing agent-team.ts"
    @echo ""
    @echo "Setup verification complete!"
